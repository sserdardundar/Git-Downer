<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Repository Downloader</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f6f8fa;
      color: #24292e;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      padding: 20px;
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
      border-bottom: 1px solid #eaecef;
      padding-bottom: 10px;
    }
    .download-btn {
      background-color: #2ea44f;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 20px;
    }
    .download-btn:hover {
      background-color: #2c974b;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 6px;
      display: none;
    }
    .success {
      background-color: #e6ffed;
      color: #22863a;
      border: 1px solid #b4e2c5;
    }
    .error {
      background-color: #ffeef0;
      color: #cb2431;
      border: 1px solid #f9c4c9;
    }
    .processing {
      background-color: #f1f8ff;
      color: #0366d6;
      border: 1px solid #c8e1ff;
    }
    .file-info {
      margin: 20px 0;
      font-size: 14px;
      color: #586069;
    }
    .download-methods {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .download-methods h3 {
      margin-top: 0;
      font-size: 16px;
    }
    .download-methods button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GitHub Repository Downloader</h1>
    
    <div class="file-info">
      <div id="filename">Processing download...</div>
      <div id="filesize"></div>
    </div>
    
    <div id="status" class="status processing">
      Preparing download...
    </div>
    
    <button id="download-btn" class="download-btn">Start Download</button>
    
    <div id="download-methods" class="download-methods">
      <h3>If download doesn't start automatically, try another method:</h3>
      <button id="method-blob" class="download-btn">Method 1: Direct Download</button>
      <button id="method-chrome" class="download-btn">Method 2: Chrome API</button>
      <button id="method-filesaver" class="download-btn">Method 3: FileSaver</button>
    </div>
  </div>

  <script>
    let blobData = null;
    let blobUrl = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const blobId = urlParams.get('blobId');
      const fileName = urlParams.get('fileName') || 'download.zip';
      const fileSize = urlParams.get('fileSize') || '';
      const autoStart = urlParams.get('autoStart') === 'true';
      
      const downloadBtn = document.getElementById('download-btn');
      const methodsDiv = document.getElementById('download-methods');
      const blobMethodBtn = document.getElementById('method-blob');
      const chromeMethodBtn = document.getElementById('method-chrome');
      const fileSaverMethodBtn = document.getElementById('method-filesaver');
      const status = document.getElementById('status');
      const filenameEl = document.getElementById('filename');
      const filesizeEl = document.getElementById('filesize');
      
      // Update UI with file information
      filenameEl.textContent = fileName;
      if (fileSize) {
        filesizeEl.textContent = `Size: ${fileSize} MB`;
      }
      
      // Show status
      function showStatus(message, type) {
        status.textContent = message;
        status.style.display = 'block';
        status.className = 'status ' + type;
      }
      
      // Method 1: Direct blob URL download
      function downloadWithBlobUrl() {
        if (!blobData) {
          showStatus('No blob data available. Please try retrieving the file data first.', 'error');
          return;
        }
        
        try {
          showStatus('Creating download link...', 'processing');
          
          // Create blob URL
          if (!blobUrl) {
            blobUrl = URL.createObjectURL(blobData);
          }
          
          // Create download link and click it
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = fileName;
          a.target = '_blank'; // Force new tab to avoid navigation issues
          document.body.appendChild(a);
          a.click();
          
          // Cleanup
          setTimeout(() => {
            document.body.removeChild(a);
            showStatus('Download initiated with Method 1!', 'success');
          }, 100);
        } catch (error) {
          showStatus(`Error with Method 1: ${error.message}`, 'error');
          console.error('Download error (Method 1):', error);
        }
      }
      
      // Method 2: Chrome API download
      function downloadWithChromeAPI() {
        if (!blobData) {
          showStatus('No blob data available. Please try retrieving the file data first.', 'error');
          return;
        }
        
        try {
          showStatus('Using Chrome download API...', 'processing');
          
          // Create blob URL if not already created
          if (!blobUrl) {
            blobUrl = URL.createObjectURL(blobData);
          }
          
          // Use Chrome API
          chrome.runtime.sendMessage({
            action: "downloadWithUrl",
            url: blobUrl,
            filename: fileName
          }, response => {
            if (chrome.runtime.lastError) {
              showStatus(`Chrome API error: ${chrome.runtime.lastError.message}`, 'error');
              console.error('Chrome API error:', chrome.runtime.lastError);
            } else if (response && response.success) {
              showStatus('Download initiated with Chrome API!', 'success');
            } else {
              showStatus(`Chrome API failed: ${response?.error || 'Unknown error'}`, 'error');
            }
          });
        } catch (error) {
          showStatus(`Error with Method 2: ${error.message}`, 'error');
          console.error('Download error (Method 2):', error);
        }
      }
      
      // Method 3: FileSaver download
      function downloadWithFileSaver() {
        if (!blobData) {
          showStatus('No blob data available. Please try retrieving the file data first.', 'error');
          return;
        }
        
        try {
          showStatus('Using FileSaver library...', 'processing');
          
          // Dynamically load FileSaver.js
          const script = document.createElement('script');
          script.src = chrome.runtime.getURL('FileSaver.min.js');
          script.onload = () => {
            try {
              // Check if saveAs is available
              if (typeof saveAs !== 'function') {
                throw new Error('FileSaver.js not loaded correctly');
              }
              
              // Use FileSaver
              saveAs(blobData, fileName);
              showStatus('Download initiated with FileSaver!', 'success');
            } catch (fsError) {
              showStatus(`FileSaver error: ${fsError.message}`, 'error');
              console.error('FileSaver error:', fsError);
            }
          };
          script.onerror = () => {
            showStatus('Failed to load FileSaver.js', 'error');
          };
          document.head.appendChild(script);
        } catch (error) {
          showStatus(`Error with Method 3: ${error.message}`, 'error');
          console.error('Download error (Method 3):', error);
        }
      }
      
      // Function to retrieve and download the blob
      function retrieveAndDownload() {
        showStatus('Retrieving file data...', 'processing');
        
        // Request the blob from the background script
        chrome.runtime.sendMessage(
          { action: "requestDownloadBlob", blobId },
          response => {
            if (chrome.runtime.lastError) {
              showStatus(`Error: ${chrome.runtime.lastError.message}`, 'error');
              return;
            }
            
            if (!response || !response.success) {
              showStatus(`Error: ${response.error || 'Failed to retrieve file data'}`, 'error');
              return;
            }
            
            try {
              // Store the blob data for alternative methods
              blobData = response.blob;
              
              // Show all download methods
              methodsDiv.style.display = 'block';
              
              // Try direct download first
              downloadWithBlobUrl();
            } catch (error) {
              showStatus(`Error: ${error.message}`, 'error');
              console.error('Download error:', error);
              methodsDiv.style.display = 'block';
            }
          }
        );
      }
      
      // Set up download buttons
      downloadBtn.addEventListener('click', retrieveAndDownload);
      blobMethodBtn.addEventListener('click', downloadWithBlobUrl);
      chromeMethodBtn.addEventListener('click', downloadWithChromeAPI);
      fileSaverMethodBtn.addEventListener('click', downloadWithFileSaver);
      
      // Auto-start download if requested
      if (autoStart) {
        downloadBtn.click();
      }
    });
  </script>
</body>
</html> 